<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Conciliador Mágico - Osiris</title>
    
    <!-- Tailwind CSS para estilização -->
    <script src="https://cdn.tailwindcss.com"></script>
    
    <!-- Bibliotecas React -->
    <script src="https://unpkg.com/react@18/umd/react.development.js"></script>
    <script src="https://unpkg.com/react-dom@18/umd/react-dom.development.js"></script>
    
    <!-- Babel para traduzir JSX no navegador -->
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    
    <!-- SheetJS (xlsx) para ler arquivos Excel/CSV -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
    
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap');
        body { font-family: 'Inter', sans-serif; }
        .drop-zone { border: 2px dashed #cbd5e1; transition: background-color 0.2s, border-color 0.2s; }
        .drop-zone.drag-over { background-color: #e2e8f0; border-color: #4f46e5; }
        .spinner { border-top-color: #4f46e5; animation: spin 1s linear infinite; }
        @keyframes spin { to { transform: rotate(360deg); } }
        .modal { transition: opacity 0.25s ease; }
        .modal-content { transition: transform 0.25s ease; }
        .clickable-row { cursor: pointer; }
    </style>
</head>
<body class="bg-gray-100">
    <div id="root"></div>

    <script type="text/babel">
        const { useState, useEffect } = React;

        // --- BANCO DE FRASES BEM HUMORADAS ---
        const phrases = { 
            title: [ "Conciliador Mágico (Quase!)", "O Exterminador de Diferenças", "Tira-Teima Contábil", "Onde a Conta Fecha (ou não)", "Desvendando o Razão", "Operação Saldo Zero", "Razão x Emoção", "O Senhor dos Lançamentos", "Ativo vs Passivo: A Batalha Final" ],
            subtitle: [ "Onde débitos e créditos finalmente fazem as pazes.", "Se não bater, a culpa é do sistema anterior.", "Transformando caos contábil em planilhas organizadas.", "Mais eficiente que um estagiário com café.", "Conciliando mais rápido que a Receita Federal te notifica.", "Sua planilha nunca mais será a mesma.", "Fazendo o balancete bater desde 2024." ],
            dropzoneTitle: [ "Jogue seus extratos aqui!", "Alimente o monstro da conciliação!", "Pode soltar a planilha do terror.", "Arraste o problema pra cá."],
            dropzoneSubtitle: [ "Prometemos não contar pra ninguém a bagunça.", "Sem julgamentos, só resultados.", "Vamos dar um jeito nisso.", "Confia na planilha." ],
            loading: [ "Cruzando dados... Tomando um cafezinho...", "Analisando os hieróglifos do seu extrato...", "Consultando os astros da contabilidade...", "Alinhando os chakras financeiros...", "Fazendo mais contas que a calculadora do celular.", "Procurando diferenças como se fosse o Wally." ],
            verdict: ["O Veredito do Tira-Teima Contábil!", "A verdade por trás dos números!", "Resultado da Autópsia Financeira:", "E o resultado do exame é..."],
            finalBalance: ["Saldo Final (Após o apocalipse):", "O que sobrou no caixa:", "Resumo da ópera:", "Situação final da conta:"],
            openItems: ["Débitos em Fuga (Itens em Aberto)", "Contas a acertar (com urgência!)", "Créditos esperando um milagre:", "Onde foi parar o dinheiro?"],
            unmatchedItems: ["Pagamentos Fantasmas (Sem Provisão)", "Lançamentos Misteriosos", "Débitos sem pai nem mãe:", "De onde veio esse pagamento?"]
        };

        const getRandomPhrase = (category) => {
            const categoryPhrases = phrases[category];
            return categoryPhrases[Math.floor(Math.random() * categoryPhrases.length)];
        };

        // --- Componente do Modal de Detalhes ---
        const DetailsModal = ({ isOpen, onClose, data, config }) => {
            if (!isOpen || !data) return null;

            const { id, allTransactions, totalCredit, totalDebit } = data;
            const balance = config.provisionField === 'credit' ? totalCredit - totalDebit : totalDebit - totalCredit;

            return (
                <div className="fixed inset-0 bg-gray-900 bg-opacity-50 flex items-center justify-center p-4 z-50">
                    <div className="modal-content bg-white w-full max-w-3xl rounded-2xl shadow-xl p-6 sm:p-8">
                        <div className="flex justify-between items-center mb-4">
                            <h3 className="text-2xl font-bold text-gray-800">Auditoria da Conciliação</h3>
                            <button onClick={onClose} className="text-gray-400 hover:text-gray-700 text-3xl leading-none">&times;</button>
                        </div>
                        <p className="text-gray-600 mb-4">Documento: <span className="font-bold">{id}</span></p>
                        <div className="overflow-y-auto max-h-96">
                            <table className="min-w-full">
                                <thead className="bg-gray-50 sticky top-0">
                                    <tr>
                                        <th className="px-4 py-2 text-left text-xs font-bold text-gray-600 uppercase">Data</th>
                                        <th className="px-4 py-2 text-left text-xs font-bold text-gray-600 uppercase">Histórico</th>
                                        <th className="px-4 py-2 text-right text-xs font-bold text-gray-600 uppercase">Débito (R$)</th>
                                        <th className="px-4 py-2 text-right text-xs font-bold text-gray-600 uppercase">Crédito (R$)</th>
                                    </tr>
                                </thead>
                                <tbody className="divide-y divide-gray-200">
                                    {allTransactions.map((t, index) => (
                                        <tr key={index}>
                                            <td className="px-4 py-2 text-sm text-gray-700">{t.date}</td>
                                            <td className="px-4 py-2 text-sm text-gray-500">{t.description}</td>
                                            <td className={`px-4 py-2 text-sm text-right font-mono ${t.debit > 0 ? 'text-blue-600' : ''}`}>{t.debit > 0 ? t.debit.toFixed(2) : ''}</td>
                                            <td className={`px-4 py-2 text-sm text-right font-mono ${t.credit > 0 ? 'text-green-600' : ''}`}>{t.credit > 0 ? t.credit.toFixed(2) : ''}</td>
                                        </tr>
                                    ))}
                                </tbody>
                            </table>
                        </div>
                        <div className="mt-6 pt-4 border-t text-right">
                            <p>Total Provisionado: <span className="font-bold">{config.provisionField === 'credit' ? totalCredit.toLocaleString('pt-BR', { style: 'currency', currency: 'BRL' }) : totalDebit.toLocaleString('pt-BR', { style: 'currency', currency: 'BRL' })}</span></p>
                            <p>Total Pago/Recebido: <span className="font-bold">{config.paymentField === 'debit' ? totalDebit.toLocaleString('pt-BR', { style: 'currency', currency: 'BRL' }) : totalCredit.toLocaleString('pt-BR', { style: 'currency', currency: 'BRL' })}</span></p>
                            <p className="text-xl font-bold mt-2">Saldo em Aberto: <span className={balance > 0 ? 'text-red-600' : 'text-blue-600'}>{balance.toLocaleString('pt-BR', { style: 'currency', currency: 'BRL' })}</span></p>
                        </div>
                    </div>
                </div>
            );
        };

        // --- Componente Principal da Conciliação ---
        const Reconciler = ({ config, onBackToMenu }) => {
            const [filesToProcess, setFilesToProcess] = useState([]);
            const [isLoading, setIsLoading] = useState(false);
            const [results, setResults] = useState(null);
            const [modalData, setModalData] = useState(null);
            const [reconciliationData, setReconciliationData] = useState({});

            const [uiPhrases, setUiPhrases] = useState({});

            useEffect(() => {
                setUiPhrases({
                    title: getRandomPhrase('title'),
                    subtitle: getRandomPhrase('subtitle'),
                    dropzoneTitle: getRandomPhrase('dropzoneTitle'),
                    dropzoneSubtitle: getRandomPhrase('dropzoneSubtitle'),
                    loading: getRandomPhrase('loading'),
                    verdict: getRandomPhrase('verdict'),
                    finalBalance: getRandomPhrase('finalBalance'),
                    openItems: getRandomPhrase('openItems'),
                    unmatchedItems: getRandomPhrase('unmatchedItems')
                });
            }, []);

            const handleFileDrop = (e) => {
                e.preventDefault();
                e.currentTarget.classList.remove('drag-over');
                handleFiles(e.dataTransfer.files);
            };

            const handleFiles = (files) => {
                setFilesToProcess(Array.from(files));
            };
            
            const formatDate = (dateInput) => {
                if (!dateInput) return '';
                if (dateInput instanceof Date) {
                    if (isNaN(dateInput.getTime())) return 'Data Inválida';
                    return dateInput.toLocaleDateString('pt-BR', { timeZone: 'UTC' });
                }
                if (typeof dateInput === 'string' && /^\d{1,2}\/\d{1,2}\/\d{2,4}$/.test(dateInput)) {
                    return dateInput;
                }
                return 'Data Inválida';
            };

            const parseCurrency = (value) => {
                if (typeof value !== 'string' && typeof value !== 'number') return 0;
                let strValue = String(value).replace(/[A-Z\s$]/g, '').trim();
                if (strValue.match(/(\d\.\d{3},\d{2})$/)) {
                    strValue = strValue.replace(/\./g, '').replace(',', '.');
                } else {
                    strValue = strValue.replace(/,/g, '');
                }
                return parseFloat(strValue) || 0;
            };

            const findHeaderMapping = (json) => {
                const headerKeywords = {
                    date: ['data'],
                    description: ['histórico', 'historico', 'histórico completo'],
                    debit: ['débito', 'debito'],
                    credit: ['crédito', 'credito'],
                    balance: ['saldo']
                };

                for (let i = 0; i < Math.min(json.length, 20); i++) {
                    const row = json[i];
                    if (!row || !Array.isArray(row) || row.length < 3) continue;
                    
                    const mapping = {};
                    let foundCount = 0;
                    
                    for (const key in headerKeywords) {
                        for (const keyword of headerKeywords[key]) {
                            const index = row.findIndex(cell => typeof cell === 'string' && cell.toLowerCase().trim().includes(keyword));
                            if (index !== -1) {
                                if (!mapping[key]) {
                                    mapping[key] = index;
                                    foundCount++;
                                }
                            }
                        }
                    }
                    
                    if (foundCount >= 4 && mapping.hasOwnProperty('date') && mapping.hasOwnProperty('debit') && mapping.hasOwnProperty('credit') && mapping.hasOwnProperty('description')) {
                        mapping.headerRowIndex = i;
                        return mapping;
                    }
                }
                return null;
            }

            const parseExcel = (file) => {
                return new Promise((resolve, reject) => {
                    const reader = new FileReader();
                    reader.onload = (e) => {
                        try {
                            if (!window.XLSX) {
                                throw new Error("Biblioteca de leitura de Excel (XLSX) não carregou.");
                            }
                            const workbook = window.XLSX.read(new Uint8Array(e.target.result), { type: 'array', cellDates: true });
                            const worksheet = workbook.Sheets[workbook.SheetNames[0]];
                            const json = window.XLSX.utils.sheet_to_json(worksheet, { header: 1, raw: false });
                            
                            let mapping;
                            if (config.parser === 'winthor_fixed') {
                                mapping = { date: 3, description: 6, debit: 7, credit: 8, balance: 9, headerRowIndex: 0 };
                            } else {
                                mapping = findHeaderMapping(json);
                            }

                            if (!mapping) {
                               throw new Error("Não foi possível identificar o cabeçalho do arquivo. Verifique se as colunas 'Data', 'Histórico', 'Débito' e 'Crédito' existem.");
                            }

                            let initialBalance = 0;
                            const dataRows = json.slice(mapping.headerRowIndex + 1);

                            const saldoRow = dataRows.find(row => row && String(row[mapping.description]).toLowerCase().includes('saldo anterior'));
                            if (saldoRow && mapping.hasOwnProperty('balance')) {
                                initialBalance = parseCurrency(saldoRow[mapping.balance]);
                            } else {
                                 const firstRow = dataRows.find(row => row && row[mapping.date]);
                                 if (firstRow && mapping.hasOwnProperty('balance')) {
                                    const firstRowBalanceStr = String(firstRow[mapping.balance] || '0').toUpperCase();
                                    const firstRowDebit = parseCurrency(firstRow[mapping.debit]);
                                    const firstRowCredit = parseCurrency(firstRow[mapping.credit]);
                                    const balanceValue = parseCurrency(firstRowBalanceStr);
                                    if (firstRowBalanceStr.includes('C')) {
                                        initialBalance = balanceValue + firstRowDebit - firstRowCredit;
                                    } else if (firstRowBalanceStr.includes('D')) {
                                        initialBalance = balanceValue - firstRowDebit + firstRowCredit;
                                    }
                                 }
                            }

                            const extractId = (text) => {
                                if (!text) return null;
                                let match;
                                if (config.idType === 'competence') {
                                    match = String(text).match(/(\d{2}\/\d{2,4})/);
                                } else {
                                    match = String(text).match(/\b(\d{5,})\b/);
                                }
                                return match ? match[1] : null;
                            };

                            const transactions = dataRows.map(row => {
                                if (!row) return null;
                                const date = formatDate(row[mapping.date]);
                                const description = row[mapping.description] ? String(row[mapping.description]).trim() : '';
                                const transactionId = extractId(description);
                                const debit = parseCurrency(row[mapping.debit]);
                                const credit = parseCurrency(row[mapping.credit]);

                                if (date && description && (debit > 0 || credit > 0)) {
                                    return { date, description, debit, credit, transactionId };
                                }
                                return null;
                            }).filter(Boolean);
                            
                            resolve({ transactions, initialBalance });
                        } catch (err) { reject(err); }
                    };
                    reader.onerror = reject;
                    reader.readAsArrayBuffer(file);
                });
            }

            const reconcile = (transactions, initialBalance = 0) => {
                const localReconData = {};
                let totalCreditPeriod = 0;
                let totalDebitPeriod = 0;

                transactions.forEach(t => {
                    totalCreditPeriod += t.credit;
                    totalDebitPeriod += t.debit;
                });
                
                const provisionField = config.provisionField;
                const paymentField = config.paymentField;

                const provisionedIds = new Set(transactions.filter(t => t[provisionField] > 0 && t.transactionId).map(t => t.transactionId));
                let orphanPayments = transactions.filter(t => t[paymentField] > 0 && !provisionedIds.has(t.transactionId));
                const matchedTransactions = transactions.filter(t => t.transactionId);

                matchedTransactions.forEach(t => {
                    if (!localReconData[t.transactionId]) {
                        localReconData[t.transactionId] = { totalDebit: 0, totalCredit: 0, allTransactions: [] };
                    }
                    localReconData[t.transactionId].totalDebit += t.debit;
                    localReconData[t.transactionId].totalCredit += t.credit;
                    localReconData[t.transactionId].allTransactions.push(t);
                });
                
                if (initialBalance > 0.01) {
                    const sumOrphanPayments = orphanPayments.reduce((sum, p) => sum + p[paymentField], 0);
                    
                    if (Math.abs(sumOrphanPayments - initialBalance) < 0.01) {
                        const initialTransaction = { date: 'Período Anterior', description: 'Saldo Inicial', credit: config.id.includes('fornecedores') || config.id.includes('impostos') ? initialBalance : 0, debit: config.id.includes('clientes') ? initialBalance : 0 };
                        localReconData['SALDO INICIAL'] = {
                            totalCredit: initialTransaction.credit + orphanPayments.reduce((s, p) => s + p.credit, 0),
                            totalDebit: initialTransaction.debit + orphanPayments.reduce((s, p) => s + p.debit, 0),
                            allTransactions: [ initialTransaction, ...orphanPayments ]
                        };
                        orphanPayments = [];
                    } else {
                        localReconData['SALDO INICIAL'] = {
                            totalCredit: config.id.includes('fornecedores') || config.id.includes('impostos') ? initialBalance : 0,
                            totalDebit: config.id.includes('clientes') ? initialBalance : 0,
                            allTransactions: [{ date: 'Período Anterior', description: 'Saldo Inicial', credit: config.id.includes('fornecedores') || config.id.includes('impostos') ? initialBalance : 0, debit: config.id.includes('clientes') ? initialBalance : 0 }]
                        };
                    }
                }

                const openProvisions = [];
                for (const id in localReconData) {
                    const group = localReconData[id];
                    const balance = config.provisionField === 'credit' ? group.totalCredit - group.totalDebit : group.totalDebit - group.totalCredit;
                    if (balance > 0.01) {
                        const provision = group.allTransactions.find(t => t[provisionField] > 0) || group.allTransactions[0];
                        openProvisions.push({ id, balance, totalCredit: group.totalCredit, totalDebit: group.totalDebit, date: provision?.date || 'N/A' });
                    }
                }
                
                setReconciliationData(localReconData);
                
                let finalBalance = 0;
                if (config.id.includes('fornecedores') || config.id.includes('impostos')) {
                    finalBalance = initialBalance + totalCreditPeriod - totalDebitPeriod;
                } else {
                    finalBalance = initialBalance + totalDebitPeriod - totalCreditPeriod;
                }

                setResults({
                    openProvisions,
                    unmatchedPayments: orphanPayments,
                    finalBalance: finalBalance
                });
            };
            
            const handleReconcileClick = async () => {
                if (filesToProcess.length === 0) return;
                setIsLoading(true);
                setUiPhrases(prev => ({ ...prev, loading: getRandomPhrase('loading') }));
                setResults(null);
                
                let allData = { transactions: [], initialBalance: 0 };
                for (const file of filesToProcess) {
                    try {
                        const parsedData = await parseExcel(file);
                        allData.transactions.push(...parsedData.transactions);
                        if (parsedData.initialBalance !== 0 && allData.initialBalance === 0) {
                            allData.initialBalance = parsedData.initialBalance;
                        }
                    } catch (error) {
                        console.error(`Error processing file ${file.name}:`, error);
                        alert(`Could not process file ${file.name}. Please check the format and try again. Error: ${error.message}`);
                    }
                }
                
                reconcile(allData.transactions, allData.initialBalance);
                setIsLoading(false);
            };

            const downloadCSV = () => {
                if(!results) return;
                let csvContent = "";
                
                csvContent += "PROVISOES COM SALDO EM ABERTO\r\n";
                csvContent += "Data,Documento,Valor,Observacoes\r\n";
                results.openProvisions.forEach(item => {
                    let obs = '';
                    if (item.id === 'SALDO INICIAL') {
                        obs = 'Saldo vindo do período anterior.';
                    } else if (reconciliationData[item.id]) {
                        obs = analyzeInstallments(reconciliationData[item.id]);
                    }
                    const row = [item.date, item.id, item.balance.toFixed(2).replace('.',','), `"${obs.replace(/"/g, '""')}"`];
                    csvContent += row.join(',') + '\r\n';
                });

                csvContent += "\r\n";
                csvContent += "PAGAMENTOS SEM PROVISAO CORRESPONDENTE\r\n";
                csvContent += "Data,Historico,Valor,Observacoes\r\n";
                results.unmatchedPayments.forEach(item => {
                    const obs = `Pagamento nao vinculado a nenhuma NF ou ao Saldo Inicial.`;
                    const row = [item.date, `"${item.description.replace(/"/g, '""')}"`, item[config.paymentField].toFixed(2).replace('.',','), `"${obs}"`];
                    csvContent += row.join(',') + '\r\n';
                });

                csvContent += "\r\n";
                csvContent += `SALDO FINAL DO RAZAO,${results.finalBalance.toFixed(2).replace('.',',')}\r\n`;

                const blob = new Blob(["\uFEFF" + csvContent], { type: 'text/csv;charset=utf-8;' });
                const link = document.createElement("a");
                const url = URL.createObjectURL(blob);
                link.setAttribute("href", url);
                link.setAttribute("download", `relatorio_${config.id}.csv`);
                link.style.visibility = 'hidden';
                document.body.appendChild(link);
                link.click();
                document.body.removeChild(link);
            };

            const analyzeInstallments = (group) => {
                if (!group || !group.allTransactions) return "Dados insuficientes para análise.";
                
                const provisionField = config.provisionField;
                const paymentField = config.paymentField;

                const payments = group.allTransactions.filter(t => t[paymentField] > 0).sort((a, b) => new Date(a.date.split('/').reverse().join('-')) - new Date(b.date.split('/').reverse().join('-')));
                const provision = group.allTransactions.find(t => t[provisionField] > 0);
                
                if (!provision) return `Anomalia: Grupo sem provisão.`;
                if (payments.length === 0) return `Provisão de ${(provision[provisionField] || 0).toLocaleString('pt-BR', { style: 'currency', currency: 'BRL' })} sem pagamentos.`;

                const provisionValue = provision[provisionField];
                const significantPayments = payments.filter(p => p[paymentField] > provisionValue * 0.05);
                const avgPayment = significantPayments.length > 0 ? significantPayments.reduce((sum, p) => sum + p[paymentField], 0) / significantPayments.length : 0;

                if (avgPayment === 0) return `Provisão de ${group.totalCredit.toLocaleString('pt-BR', { style: 'currency', currency: 'BRL' })} com pagamento de ${group.totalDebit.toLocaleString('pt-BR', { style: 'currency', currency: 'BRL' })}.`;

                const expectedInstallments = Math.round(provisionValue / avgPayment);
                
                for (let i = 0; i < payments.length - 1; i++) {
                    const date1 = new Date(payments[i].date.split('/').reverse().join('-'));
                    const date2 = new Date(payments[i+1].date.split('/').reverse().join('-'));
                    const monthDiff = (date2.getFullYear() - date1.getFullYear()) * 12 + (date2.getMonth() - date1.getMonth());
                    if (monthDiff > 1) {
                        const missingMonth = new Date(date1.setMonth(date1.getMonth() + 1));
                        const monthName = missingMonth.toLocaleString('pt-BR', { month: 'long' });
                        return `Alerta de calote! Possível falta de pagamento em ${monthName}/${missingMonth.getFullYear()}.`;
                    }
                }
                
                const balance = config.provisionField === 'credit' ? group.totalCredit - group.totalDebit : group.totalDebit - group.totalCredit;
                if (payments.length < expectedInstallments && balance > avgPayment * 0.5) return `Tudo certo por aqui. A(s) próxima(s) parcela(s) deve(m) vir no período seguinte.`;

                return `Provisão de ${group.totalCredit.toLocaleString('pt-BR', { style: 'currency', currency: 'BRL' })} com pagamento de ${group.totalDebit.toLocaleString('pt-BR', { style: 'currency', currency: 'BRL' })}.`;
            };

            return (
                <div className="w-full">
                    <button onClick={onBackToMenu} className="mb-4 text-indigo-600 hover:text-indigo-800 font-medium">&larr; Voltar ao Menu</button>
                    <div className="text-center mb-8">
                        <h1 className="text-3xl sm:text-4xl font-bold text-gray-800">{config.title}</h1>
                        <p className="text-gray-500 mt-2">{config.subtitle}</p>
                    </div>

                    <div id="drop-zone" onDrop={handleFileDrop} onDragOver={(e) => e.preventDefault()} onDragEnter={(e) => e.currentTarget.classList.add('drag-over')} onDragLeave={(e) => e.currentTarget.classList.remove('drag-over')} className="drop-zone relative flex flex-col items-center justify-center p-10 rounded-xl text-center cursor-pointer hover:bg-gray-50">
                        <svg className="w-16 h-16 text-gray-400 mb-4" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" strokeWidth="1.5" stroke="currentColor"><path strokeLinecap="round" strokeLinejoin="round" d="M3 16.5v2.25A2.25 2.25 0 005.25 21h13.5A2.25 2.25 0 0021 18.75V16.5m-13.5-9L12 3m0 0l4.5 4.5M12 3v13.5" /></svg>
                        <p className="font-semibold text-gray-700">{uiPhrases.dropzoneTitle}</p>
                        <p className="text-sm text-gray-500 mt-1">{uiPhrases.dropzoneSubtitle}</p>
                        <input type="file" id="file-input" onChange={(e) => handleFiles(e.target.files)} className="absolute inset-0 w-full h-full opacity-0 cursor-pointer" multiple accept=".xls,.xlsx,.csv" />
                    </div>

                    {filesToProcess.length > 0 && (
                        <div className="mt-6 text-center">
                            <p className="font-medium text-gray-800">Arquivos na mira:</p>
                            <div className="text-sm text-gray-600 mt-2 space-y-1">{filesToProcess.map(f => <p key={f.name} className="truncate">{f.name}</p>)}</div>
                            <button onClick={handleReconcileClick} className="mt-6 w-full sm:w-auto bg-indigo-600 text-white font-bold py-3 px-8 rounded-lg shadow-md hover:bg-indigo-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-indigo-500 transition-transform transform hover:scale-105">Fazer a Mágica!</button>
                        </div>
                    )}

                    {isLoading && (
                        <div className="text-center my-8">
                            <div className="spinner w-12 h-12 rounded-full border-4 border-gray-200 mx-auto"></div>
                            <p className="mt-4 text-gray-600 font-medium">{uiPhrases.loading}</p>
                        </div>
                    )}

                    {results && (
                        <div className="mt-10">
                            <div className="text-center mb-6"><h2 className="text-2xl font-bold text-gray-800">{uiPhrases.verdict}</h2></div>
                            <div className="mb-8 p-4 bg-gray-50 rounded-lg flex flex-col sm:flex-row justify-between items-center">
                                <div>
                                    <p className="text-gray-600">{uiPhrases.finalBalance}</p>
                                    <p className={`text-2xl font-bold ${results.finalBalance >= 0 ? 'text-green-700' : 'text-red-700'}`}>{results.finalBalance.toLocaleString('pt-BR', { style: 'currency', currency: 'BRL' })}</p>
                                </div>
                                <button onClick={downloadCSV} className="mt-4 sm:mt-0 w-full sm:w-auto bg-green-600 text-white font-bold py-2 px-6 rounded-lg shadow-md hover:bg-green-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-green-500 transition-transform transform hover:scale-105">Baixar Provas (CSV)</button>
                            </div>

                            <div>
                                <h2 className="text-2xl font-bold text-gray-800 mb-4">{uiPhrases.openItems}</h2>
                                <div className="overflow-x-auto">
                                    <table className="min-w-full bg-white border border-gray-200 rounded-lg">
                                        <thead className="bg-gray-50"><tr><th className="px-6 py-3 text-left text-xs font-bold text-gray-600 uppercase tracking-wider">Data</th><th className="px-6 py-3 text-left text-xs font-bold text-gray-600 uppercase tracking-wider">NF / Documento</th><th className="px-6 py-3 text-left text-xs font-bold text-gray-600 uppercase tracking-wider">Valor Pendente (R$)</th><th className="px-6 py-3 text-left text-xs font-bold text-gray-600 uppercase tracking-wider">Observações do Detetive</th></tr></thead>
                                        <tbody className="divide-y divide-gray-200">
                                            {results.openProvisions.sort((a, b) => (a.date === 'Período Anterior' ? -1 : b.date === 'Período Anterior' ? 1 : new Date(a.date.split('/').reverse().join('-')) - new Date(b.date.split('/').reverse().join('-')))).map(item => (
                                                <tr key={item.id} onClick={() => setModalData(reconciliationData[item.id])} className="hover:bg-gray-50 clickable-row">
                                                    <td className="px-6 py-4 whitespace-nowrap text-sm text-gray-700">{item.date}</td>
                                                    <td className="px-6 py-4 whitespace-nowrap text-sm text-gray-700 font-medium">{item.id}</td>
                                                    <td className={`px-6 py-4 whitespace-nowrap text-sm ${item.balance > 0 ? 'text-red-600' : 'text-blue-600'} font-semibold`}>{item.balance.toLocaleString('pt-BR', { style: 'currency', currency: 'BRL' })}</td>
                                                    <td className="px-6 py-4 text-sm text-gray-500">{item.id === 'SALDO INICIAL' ? 'Saldo vindo do período anterior.' : analyzeInstallments(reconciliationData[item.id])}</td>
                                                </tr>
                                            ))}
                                        </tbody>
                                    </table>
                                </div>
                                {results.openProvisions.length === 0 && <p className="text-center text-gray-500 py-6">Parabéns! Nenhum centavo foragido por aqui.</p>}
                            </div>

                            <div className="mt-10">
                                <h2 className="text-2xl font-bold text-gray-800 mb-4">{uiPhrases.unmatchedItems}</h2>
                                <div className="overflow-x-auto">
                                    <table className="min-w-full bg-white border border-gray-200 rounded-lg">
                                        <thead className="bg-gray-50"><tr><th className="px-6 py-3 text-left text-xs font-bold text-gray-600 uppercase tracking-wider">Data do Pagamento</th><th className="px-6 py-3 text-left text-xs font-bold text-gray-600 uppercase tracking-wider">Histórico</th><th className="px-6 py-3 text-left text-xs font-bold text-gray-600 uppercase tracking-wider">Valor (R$)</th><th className="px-6 py-3 text-left text-xs font-bold text-gray-600 uppercase tracking-wider">Observações</th></tr></thead>
                                        <tbody className="divide-y divide-gray-200">
                                            {results.unmatchedPayments.map((item, index) => (
                                                <tr key={index} className="hover:bg-gray-50">
                                                    <td className="px-6 py-4 whitespace-nowrap text-sm text-gray-700">{item.date}</td>
                                                    <td className="px-6 py-4 whitespace-nowrap text-sm text-gray-700 font-medium">{item.description}</td>
                                                    <td className="px-6 py-4 whitespace-nowrap text-sm text-gray-700 font-semibold">{item[config.paymentField].toLocaleString('pt-BR', { style: 'currency', currency: 'BRL' })}</td>
                                                    <td className="px-6 py-4 text-sm text-gray-500">Pagamento não vinculado a nenhuma NF ou ao Saldo Inicial.</td>
                                                </tr>
                                            ))}
                                        </tbody>
                                    </table>
                                </div>
                                {results.unmatchedPayments.length === 0 && <p className="text-center text-gray-500 py-6">Incrivelmente, todos os pagamentos encontraram seu par!</p>}
                            </div>
                        </div>
                    )}
                    <DetailsModal isOpen={!!modalData} onClose={() => setModalData(null)} data={modalData} config={config} />
                </div>
            );
        };


        // --- Componente do Menu ---
        const Menu = ({ onNavigate }) => {
            return (
                <div className="text-center">
                    <h1 className="text-3xl sm:text-4xl font-bold text-gray-800">Suíte de Conciliação Contábil</h1>
                    <p className="text-gray-500 mt-2 mb-10">Escolha uma ferramenta para começar a mágica.</p>
                    <div className="grid grid-cols-1 md:grid-cols-2 gap-8">
                        <div onClick={() => onNavigate('fornecedores_winthor')} className="p-8 bg-white rounded-2xl shadow-lg hover:shadow-2xl hover:-translate-y-2 transition-all duration-300 cursor-pointer">
                            <h2 className="text-xl font-bold text-indigo-600">Fornecedores (Winthor)</h2>
                            <p className="text-gray-500 mt-2">Concilie compras e pagamentos no padrão Winthor.</p>
                        </div>
                         <div onClick={() => onNavigate('fornecedores_dominio')} className="p-8 bg-white rounded-2xl shadow-lg hover:shadow-2xl hover:-translate-y-2 transition-all duration-300 cursor-pointer">
                            <h2 className="text-xl font-bold text-indigo-800">Fornecedores (Domínio)</h2>
                            <p className="text-gray-500 mt-2">Concilie compras e pagamentos no padrão Domínio.</p>
                        </div>
                        <div onClick={() => onNavigate('clientes_winthor')} className="p-8 bg-white rounded-2xl shadow-lg hover:shadow-2xl hover:-translate-y-2 transition-all duration-300 cursor-pointer">
                            <h2 className="text-xl font-bold text-teal-600">Clientes (Winthor)</h2>
                            <p className="text-gray-500 mt-2">Verifique vendas e recebimentos no padrão Winthor.</p>
                        </div>
                         <div onClick={() => onNavigate('clientes_dominio')} className="p-8 bg-white rounded-2xl shadow-lg hover:shadow-2xl hover:-translate-y-2 transition-all duration-300 cursor-pointer">
                            <h2 className="text-xl font-bold text-teal-800">Clientes (Domínio)</h2>
                            <p className="text-gray-500 mt-2">Verifique vendas e recebimentos no padrão Domínio.</p>
                        </div>
                         <div onClick={() => onNavigate('impostos_winthor')} className="p-8 bg-white rounded-2xl shadow-lg hover:shadow-2xl hover:-translate-y-2 transition-all duration-300 cursor-pointer">
                            <h2 className="text-xl font-bold text-red-600">Impostos (Winthor)</h2>
                            <p className="text-gray-500 mt-2">Concilie guias e provisões no padrão Winthor.</p>
                        </div>
                         <div onClick={() => onNavigate('impostos_dominio')} className="p-8 bg-white rounded-2xl shadow-lg hover:shadow-2xl hover:-translate-y-2 transition-all duration-300 cursor-pointer">
                            <h2 className="text-xl font-bold text-red-800">Impostos (Domínio)</h2>
                            <p className="text-gray-500 mt-2">Apure tributos no layout Domínio sem mesclagem.</p>
                        </div>
                    </div>
                </div>
            );
        };


        // --- Componente Principal da Aplicação ---
        const App = () => {
            const [page, setPage] = useState('menu');
            const [scriptsReady, setScriptsReady] = useState(false);

            useEffect(() => {
                if (window.XLSX) {
                    setScriptsReady(true);
                    return;
                }
                const script = document.createElement('script');
                script.id = 'xlsx-script';
                script.src = "https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js";
                script.async = true;
                script.onload = () => {
                    setScriptsReady(true);
                };
                document.body.appendChild(script);
            }, []);


            const configs = {
                fornecedores_winthor: {
                    id: 'fornecedores_winthor',
                    title: 'Conciliador de Fornecedores (Winthor)',
                    subtitle: 'Vamos ver quem você está devendo...',
                    provisionField: 'credit',
                    paymentField: 'debit',
                    idType: 'nf',
                    parser: 'winthor_fixed'
                },
                 fornecedores_dominio: {
                    id: 'fornecedores_dominio',
                    title: 'Conciliador de Fornecedores (Domínio)',
                    subtitle: 'Vamos ver quem você está devendo...',
                    provisionField: 'credit',
                    paymentField: 'debit',
                    idType: 'nf',
                    parser: 'auto'
                },
                clientes_winthor: {
                    id: 'clientes_winthor',
                    title: 'Conciliador de Clientes (Winthor)',
                    subtitle: 'Hora de cobrar a galera!',
                    provisionField: 'debit',
                    paymentField: 'credit',
                    idType: 'nf',
                    parser: 'winthor_fixed'
                },
                clientes_dominio: {
                    id: 'clientes_dominio',
                    title: 'Conciliador de Clientes (Domínio)',
                    subtitle: 'Hora de cobrar a galera!',
                    provisionField: 'debit',
                    paymentField: 'credit',
                    idType: 'nf',
                    parser: 'auto'
                },
                impostos_winthor: {
                    id: 'impostos_winthor',
                    title: 'Conciliador de Impostos (Winthor)',
                    subtitle: 'Deixando as contas com o leão em dia (padrão Winthor).',
                    provisionField: 'credit',
                    paymentField: 'debit',
                    idType: 'competence',
                    parser: 'winthor_fixed'
                },
                impostos_dominio: {
                    id: 'impostos_dominio',
                    title: 'Conciliador de Impostos (Domínio)',
                    subtitle: 'Apuração de tributos sem estresse (padrão Domínio).',
                    provisionField: 'credit',
                    paymentField: 'debit',
                    idType: 'competence',
                    parser: 'auto'
                }
            };

            const renderPage = () => {
                if (!scriptsReady) {
                    return (
                        <div className="text-center">
                            <div className="spinner w-12 h-12 rounded-full border-4 border-gray-200 mx-auto"></div>
                            <p className="mt-4 text-gray-600 font-medium">Carregando bibliotecas...</p>
                        </div>
                    );
                }

                if (configs[page]) {
                    return <Reconciler config={configs[page]} onBackToMenu={() => setPage('menu')} />;
                }
                
                return <Menu onNavigate={setPage} />;
            };

            return (
                <div className="bg-gray-100 min-h-screen flex items-center justify-center p-4">
                    <main className="bg-white w-full max-w-5xl mx-auto p-6 sm:p-8 rounded-2xl shadow-lg">
                        {renderPage()}
                    </main>
                </div>
            );
        }

        const root = ReactDOM.createRoot(document.getElementById('root'));
        root.render(<App />);

    </script>
</body>
</html>
